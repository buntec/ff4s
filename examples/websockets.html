<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Typelevel Laika + Helium Theme" />
  <title>WebSockets</title>
  
  <meta name="author" content="Christoph Bunte"/>
  
  
  <meta name="description" content="docs"/>
  
  
  
  <link rel="icon" sizes="32x32" type="image/png" href="https://typelevel.org/img/favicon.png"/>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css">
  
  <link rel="stylesheet" type="text/css" href="../helium/site/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="../helium/site/laika-helium.css" />
  <script src="../helium/site/laika-helium.js"></script>
  
  
  <script> /* for avoiding page load transitions */ </script>
</head>

  <body>

    <header id="top-bar" class="light-default dark-default">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika navigationMenu" title="Navigation">&#xefa2;</i>
    </a>
    
    
  </div>

  <a class="image-link" href="https://typelevel.org"><img src="https://typelevel.org/img/logo.svg"></a>

  <div class="row links">
    
    <a class="icon-link svg-link" href="https://github.com/buntec/ff4s"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
    <a class="icon-link svg-link" href="https://fosstodon.org/@typelevel"><span class="mastodon" title="Mastodon"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <g class="svg-shape">
    <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/>
  </g>
</svg></span></a>
    
  </div>  

</header>
    
    <nav id="sidebar">

  <div class="row">
    
    <a class="icon-link svg-link" href="https://github.com/buntec/ff4s"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
    <a class="icon-link svg-link" href="https://fosstodon.org/@typelevel"><span class="mastodon" title="Mastodon"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <g class="svg-shape">
    <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/>
  </g>
</svg></span></a>
    
  </div>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="../">ff4s</a></li>
    <li class="level1 nav-leaf"><a href="../concepts.html">Concepts</a></li>
    <li class="level1 nav-header">examples</li>
    <li class="level2 nav-leaf"><a href="counter.html">A Counter</a></li>
    <li class="level2 nav-leaf"><a href="data-fetching.html">Data Fetching</a></li>
    <li class="level2 nav-leaf"><a href="cancellation.html">Cancellation</a></li>
    <li class="level2 nav-leaf"><a href="subscriptions.html">Subscriptions</a></li>
    <li class="level2 active nav-leaf"><a href="#">WebSockets</a></li>
    <li class="level2 nav-leaf"><a href="reusable-components.html">Reusable Components</a></li>
    <li class="level1 nav-header">Related projects</li>
    <li class="level2 nav-leaf"><a href="https://typelevel.org/cats-effect">cats-effect</a></li>
    <li class="level2 nav-leaf"><a href="https://typelevel.org/fs2">fs2</a></li>
    <li class="level2 nav-leaf"><a href="https://github.com/armanbilge/fs2-dom/">fs2-dom</a></li>
    <li class="level2 nav-leaf"><a href="https://http4s.github.io/http4s-dom/">http4s-dom</a></li>
  </ul>

</nav>

    <div id="container">

      
<nav id="page-nav">
  <p class="header"><a href="#">WebSockets</a></p>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="#state">State</a></li>
    <li class="level1 nav-leaf"><a href="#action">Action</a></li>
    <li class="level1 nav-leaf"><a href="#store">Store</a></li>
    <li class="level1 nav-leaf"><a href="#view">View</a></li>
    <li class="level1 nav-leaf"><a href="#app">App</a></li>
  </ul>

  <p class="footer"></p>
</nav>


      <main class="content">

        <h1 id="websockets" class="title">WebSockets</h1>
        <p>Managing the life cycle of a WebSocket connection can be tricky.
        In ff4s we benefit from abstractions in Cats Effect and fs2
        to achieve this with ease and safety.</p>
        <p>In this example we are connecting to a simple WS server that
        echos back any message we send to it.
        We only show the common case where the lifetime of
        the connection coincides with the lifetime of the app.</p>
        
        <h2 id="state" class="section"><a class="anchor-link left" href="#state"><i class="icofont-laika link">&#xef71;</i></a>State</h2>
        <p>The state holds the user&#39;s input and the most recent server response.</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">final</span><span> </span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">State</span><span>(
    </span><span class="identifier">userInput</span><span>: </span><span class="type-name">Option</span><span>[</span><span class="type-name">String</span><span>] = </span><span class="type-name">None</span><span>,
    </span><span class="identifier">serverResponse</span><span>: </span><span class="type-name">Option</span><span>[</span><span class="type-name">String</span><span>] = </span><span class="type-name">None</span><span>
)</span></code></pre>
        
        <h2 id="action" class="section"><a class="anchor-link left" href="#action"><i class="icofont-laika link">&#xef71;</i></a>Action</h2>
        <p>The action encoding is straightforward:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">sealed</span><span> </span><span class="keyword">trait</span><span> </span><span class="type-name">Action</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">SetUserInput</span><span>(</span><span class="identifier">input</span><span>: </span><span class="type-name">Option</span><span>[</span><span class="type-name">String</span><span>]) </span><span class="keyword">extends</span><span> </span><span class="type-name">Action</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">object</span><span> </span><span class="type-name">Send</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">Action</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">SetServerResponse</span><span>(</span><span class="identifier">response</span><span>: </span><span class="type-name">String</span><span>) </span><span class="keyword">extends</span><span> </span><span class="type-name">Action</span></code></pre>
        
        <h2 id="store" class="section"><a class="anchor-link left" href="#store"><i class="icofont-laika link">&#xef71;</i></a>Store</h2>
        <p>We use a Cats Effect <code>Queue</code> to hold outgoing messages.
        The connection itself runs on a separate fiber safely
        tied to the lifetime of the store using <code>.background</code>.
        The <code>ff4s.WebsocketClient</code> is a wrapper around the more
        powerful <code>http4s</code> client and intended for simple use-cases
        such as this one.</p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">implicits</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">std</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">all</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="type-name">Stream</span><span>

</span><span class="keyword">object</span><span> </span><span class="type-name">Store</span><span> {

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]](</span><span class="keyword">implicit</span><span> </span><span class="type-name">F</span><span>: </span><span class="type-name">Async</span><span>[</span><span class="type-name">F</span><span>]) = </span><span class="keyword">for</span><span> {
    </span><span class="identifier">sendQ</span><span> &lt;- </span><span class="type-name">Queue</span><span>.</span><span class="identifier">unbounded</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">String</span><span>].</span><span class="identifier">toResource</span><span>

    </span><span class="identifier">store</span><span> &lt;- </span><span class="identifier">ff4s</span><span>.</span><span class="type-name">Store</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">State</span><span>, </span><span class="type-name">Action</span><span>](</span><span class="type-name">State</span><span>()) { </span><span class="identifier">_</span><span> =&gt;
      </span><span class="identifier">_</span><span> </span><span class="keyword">match</span><span> {
        </span><span class="keyword">case</span><span> </span><span class="type-name">SetUserInput</span><span>(</span><span class="identifier">input</span><span>) =&gt; </span><span class="identifier">_</span><span>.</span><span class="identifier">copy</span><span>(</span><span class="identifier">userInput</span><span> = </span><span class="identifier">input</span><span>) -&gt; </span><span class="identifier">none</span><span>
        </span><span class="keyword">case</span><span> </span><span class="type-name">Send</span><span> =&gt; </span><span class="identifier">state</span><span> =&gt; </span><span class="identifier">state</span><span> -&gt; </span><span class="identifier">state</span><span>.</span><span class="identifier">userInput</span><span>.</span><span class="identifier">map</span><span>(</span><span class="identifier">sendQ</span><span>.</span><span class="identifier">offer</span><span>)
        </span><span class="keyword">case</span><span> </span><span class="type-name">SetServerResponse</span><span>(</span><span class="identifier">res</span><span>) =&gt; </span><span class="identifier">_</span><span>.</span><span class="identifier">copy</span><span>(</span><span class="identifier">serverResponse</span><span> = </span><span class="identifier">res</span><span>.</span><span class="identifier">some</span><span>) -&gt; </span><span class="identifier">none</span><span>
      }
    }

    </span><span class="identifier">_</span><span> &lt;- </span><span class="identifier">ff4s</span><span>
      .</span><span class="type-name">WebSocketClient</span><span>[</span><span class="type-name">F</span><span>]
      .</span><span class="identifier">bidirectionalText</span><span>(
        </span><span class="string-literal">&quot;wss://ws.postman-echo.com/raw/&quot;</span><span>,
        </span><span class="identifier">_</span><span>.</span><span class="identifier">evalMap</span><span>(</span><span class="identifier">res</span><span> =&gt; </span><span class="identifier">store</span><span>.</span><span class="identifier">dispatch</span><span>(</span><span class="type-name">SetServerResponse</span><span>(</span><span class="identifier">res</span><span>))),
        </span><span class="type-name">Stream</span><span>.</span><span class="identifier">fromQueueUnterminated</span><span>(</span><span class="identifier">sendQ</span><span>)
      )
      .</span><span class="identifier">background</span><span>

  } </span><span class="keyword">yield</span><span> </span><span class="identifier">store</span><span>

}</span></code></pre>
        
        <h2 id="view" class="section"><a class="anchor-link left" href="#view"><i class="icofont-laika link">&#xef71;</i></a>View</h2>
        <p>There isn&#39;t much to say about the view.</p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">scalajs</span><span>.</span><span class="identifier">dom</span><span>

</span><span class="keyword">object</span><span> </span><span class="type-name">View</span><span> {

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]](</span><span class="keyword">implicit</span><span> </span><span class="identifier">dsl</span><span>: </span><span class="identifier">ff4s</span><span>.</span><span class="type-name">Dsl</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">State</span><span>, </span><span class="type-name">Action</span><span>]) = {
    </span><span class="keyword">import</span><span> </span><span class="identifier">dsl</span><span>.</span><span class="identifier">_</span><span>
    </span><span class="keyword">import</span><span> </span><span class="identifier">dsl</span><span>.</span><span class="identifier">html</span><span>.</span><span class="identifier">_</span><span>

    </span><span class="identifier">useState</span><span> { </span><span class="identifier">state</span><span> =&gt;
      </span><span class="identifier">div</span><span>(
        </span><span class="identifier">input</span><span>(
          </span><span class="identifier">tpe</span><span> := </span><span class="string-literal">&quot;text&quot;</span><span>,
          </span><span class="identifier">placeholder</span><span> := </span><span class="string-literal">&quot;your message here...&quot;</span><span>,
          </span><span class="identifier">onInput</span><span> := ((</span><span class="identifier">ev</span><span>: </span><span class="identifier">dom</span><span>.</span><span class="type-name">Event</span><span>) =&gt;
            </span><span class="identifier">ev</span><span>.</span><span class="identifier">target</span><span> </span><span class="keyword">match</span><span> {
              </span><span class="keyword">case</span><span> </span><span class="identifier">el</span><span>: </span><span class="identifier">dom</span><span>.</span><span class="type-name">HTMLInputElement</span><span> =&gt;
                </span><span class="keyword">if</span><span> (</span><span class="identifier">el</span><span>.</span><span class="identifier">value</span><span>.</span><span class="identifier">nonEmpty</span><span>) </span><span class="type-name">Some</span><span>(</span><span class="type-name">SetUserInput</span><span>(</span><span class="identifier">el</span><span>.</span><span class="identifier">value</span><span>.</span><span class="identifier">some</span><span>))
                </span><span class="keyword">else</span><span> </span><span class="type-name">Some</span><span>(</span><span class="type-name">SetUserInput</span><span>(</span><span class="type-name">None</span><span>))
              </span><span class="keyword">case</span><span> </span><span class="identifier">_</span><span> =&gt; </span><span class="type-name">None</span><span>
            }
          )
        ),
        </span><span class="identifier">button</span><span>(
          </span><span class="string-literal">&quot;Send&quot;</span><span>,
          </span><span class="identifier">disabled</span><span> := </span><span class="identifier">state</span><span>.</span><span class="identifier">userInput</span><span>.</span><span class="identifier">isEmpty</span><span>,
          </span><span class="identifier">onClick</span><span> := (</span><span class="identifier">_</span><span> =&gt; </span><span class="type-name">Send</span><span>.</span><span class="identifier">some</span><span>)
        ),
        </span><span class="identifier">state</span><span>.</span><span class="identifier">serverResponse</span><span>.</span><span class="identifier">fold</span><span>(</span><span class="identifier">empty</span><span>)(</span><span class="identifier">res</span><span> =&gt; </span><span class="identifier">div</span><span>(</span><span class="string-literal">s&quot;Server response: </span><span class="substitution">$res</span><span class="string-literal">&quot;</span><span>))
      )
    }
  }

}</span></code></pre>
        
        <h2 id="app" class="section"><a class="anchor-link left" href="#app"><i class="icofont-laika link">&#xef71;</i></a>App</h2>
        <p>The boilerplate construction of <code>ff4s.App</code> and <code>ff4s.IOEntryPoint</code> is omitted.</p>
        <div id="mdoc-html-run4" data-mdoc-js></div>
        <p><script type="text/javascript" src="websockets.md.js" defer></script>
        <script type="text/javascript" src="mdoc.js" defer></script></p>

        
<hr class="footer-rule"/>
<footer>
  ff4s is a <a href="https://typelevel.org/">Typelevel</a> project distributed under the <a href="https://www.apache.org/licenses/LICENSE-2.0.txt">Apache-2.0</a> license.
</footer>


      </main>

    </div>

  </body>

</html>